<!DOCTYPE html>
<html lang="ko" x-data="app()" x-init="init()">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>connect:seoul â€” ì–´ë“œë¯¼</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<style>
  :root { --neon: #00E5CC; --red: #FF2D55; --gold: #FFB800; }
  body { background: #0A0A0F; color: #E8E0D5; font-family: 'Pretendard', system-ui, sans-serif; }
  .neon { color: var(--neon); }
  .neon-border { border-color: var(--neon); }
  .neon-bg { background: rgba(0,229,204,0.08); }
  .card { background: #16161F; border: 1px solid #2a2a3a; border-radius: 6px; }
  .sidebar-item { transition: all .15s; }
  .sidebar-item:hover, .sidebar-item.active { background: rgba(0,229,204,0.1); border-left: 3px solid var(--neon); }
  .sidebar-item { border-left: 3px solid transparent; }
  .btn-neon { background: var(--neon); color: #0A0A0F; font-weight: 700; padding: 6px 16px; border-radius: 4px; transition: opacity .15s; }
  .btn-neon:hover { opacity: .85; }
  .btn-ghost { border: 1px solid #2a2a3a; padding: 6px 14px; border-radius: 4px; transition: all .15s; }
  .btn-ghost:hover { border-color: var(--neon); color: var(--neon); }
  .btn-danger { border: 1px solid var(--red); color: var(--red); padding: 5px 12px; border-radius: 4px; }
  .btn-danger:hover { background: rgba(255,45,85,.1); }
  input, select, textarea { background: #111118; border: 1px solid #2a2a3a; border-radius: 4px; padding: 6px 10px; color: #E8E0D5; width: 100%; outline: none; }
  input:focus, select:focus { border-color: var(--neon); }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 10px 12px; font-size: 11px; text-transform: uppercase; letter-spacing: .06em; color: #888; border-bottom: 1px solid #1e1e2e; }
  td { padding: 10px 12px; border-bottom: 1px solid #1a1a28; font-size: 13px; }
  tr:hover td { background: rgba(255,255,255,.02); }
  .badge { font-size: 11px; padding: 2px 8px; border-radius: 999px; font-weight: 600; }
  .badge-green { background: rgba(0,229,204,.15); color: var(--neon); }
  .badge-red { background: rgba(255,45,85,.15); color: var(--red); }
  .badge-gold { background: rgba(255,184,0,.15); color: var(--gold); }
  .badge-gray { background: rgba(255,255,255,.08); color: #888; }
  .stat-card { background: #16161F; border: 1px solid #2a2a3a; border-radius: 6px; padding: 20px 24px; }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.7); backdrop-filter: blur(4px); z-index: 50; display: flex; align-items: center; justify-content: center; }
  .modal { background: #16161F; border: 1px solid #2a2a3a; border-radius: 8px; padding: 28px; width: 480px; max-height: 80vh; overflow-y: auto; }
  .log-entry { font-family: monospace; font-size: 12px; padding: 6px 0; border-bottom: 1px solid #1a1a28; }
  ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #111; } ::-webkit-scrollbar-thumb { background: #2a2a3a; border-radius: 3px; }
  [x-cloak] { display: none !important; }
</style>
</head>
<body x-cloak>

<!-- â”€â”€â”€ ë¡œê·¸ì¸ â”€â”€â”€ -->
<div x-show="!token" class="min-h-screen flex items-center justify-center">
  <div class="card p-10 w-80 text-center">
    <div class="text-xs tracking-widest mb-1 text-gray-500">CONNECT:SEOUL</div>
    <div class="text-2xl font-bold neon mb-6">ì–´ë“œë¯¼ íŒ¨ë„</div>
    <form @submit.prevent="login()">
      <input type="password" x-model="loginPw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" class="mb-3" autofocus>
      <div x-show="loginError" class="text-red-400 text-xs mb-3" x-text="loginError"></div>
      <button type="submit" class="btn-neon w-full">ë¡œê·¸ì¸</button>
    </form>
  </div>
</div>

<!-- â”€â”€â”€ ë©”ì¸ ë ˆì´ì•„ì›ƒ â”€â”€â”€ -->
<div x-show="token" class="flex min-h-screen">

  <!-- ì‚¬ì´ë“œë°” -->
  <aside class="w-56 flex-shrink-0 border-r border-gray-800 flex flex-col" style="background:#111118">
    <div class="p-5 border-b border-gray-800">
      <div class="text-xs text-gray-500 tracking-widest">CONNECT:SEOUL</div>
      <div class="font-bold neon text-sm mt-1">ì–´ë“œë¯¼ íŒ¨ë„</div>
    </div>
    <nav class="flex-1 p-3 space-y-1">
      <template x-for="item in navItems" :key="item.id">
        <button @click="page = item.id; loadPage()"
          :class="['sidebar-item flex items-center gap-3 w-full text-left px-3 py-2.5 rounded text-sm', page === item.id ? 'active neon' : 'text-gray-400']">
          <span x-text="item.icon" class="text-base"></span>
          <span x-text="item.label"></span>
        </button>
      </template>
    </nav>
    <div class="p-4 border-t border-gray-800">
      <button @click="logout()" class="btn-ghost w-full text-sm text-gray-400">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </aside>

  <!-- ì½˜í…ì¸  -->
  <main class="flex-1 overflow-auto">

    <!-- ìƒë‹¨ ë°” -->
    <header class="border-b border-gray-800 px-6 py-4 flex items-center justify-between" style="background:#111118">
      <h1 class="font-bold text-base" x-text="navItems.find(n=>n.id===page)?.label || ''"></h1>
      <div class="flex items-center gap-3 text-xs text-gray-500">
        <span>ì„œë²„: <span class="neon" x-text="health.status || 'â€”'"></span></span>
        <span>ì—…íƒ€ì„: <span class="text-gray-300" x-text="uptimeStr"></span></span>
        <button @click="loadPage()" class="btn-ghost text-xs px-3 py-1.5">â†» ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </header>

    <div class="p-6">

      <!-- ë¡œë”© -->
      <div x-show="loading" class="text-center py-20 text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

      <!-- â”€â”€â”€ ëŒ€ì‹œë³´ë“œ â”€â”€â”€ -->
      <div x-show="!loading && page === 'dashboard'">
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="stat-card"><div class="text-xs text-gray-500 mb-1">í”Œë ˆì´ì–´</div><div class="text-3xl font-bold neon" x-text="stats.playerCount ?? 'â€”'"></div></div>
          <div class="stat-card"><div class="text-xs text-gray-500 mb-1">ê±°ë˜ ê±´ìˆ˜</div><div class="text-3xl font-bold" style="color:var(--gold)" x-text="stats.tradeCount ?? 'â€”'"></div></div>
          <div class="stat-card"><div class="text-xs text-gray-500 mb-1">ìƒì¸</div><div class="text-3xl font-bold text-purple-400" x-text="stats.merchantCount ?? 'â€”'"></div></div>
          <div class="stat-card"><div class="text-xs text-gray-500 mb-1">í€˜ìŠ¤íŠ¸</div><div class="text-3xl font-bold text-blue-400" x-text="stats.questCount ?? 'â€”'"></div></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="card p-4">
            <div class="text-xs text-gray-500 mb-3 font-semibold tracking-wider">ìµœê·¼ ê°€ì… í”Œë ˆì´ì–´</div>
            <table>
              <thead><tr><th>ì´ë¦„</th><th>ë ˆë²¨</th><th>ê³¨ë“œ</th><th>ê°€ì…ì¼</th></tr></thead>
              <tbody>
                <template x-for="p in stats.recentPlayers || []" :key="p.name">
                  <tr>
                    <td x-text="p.name"></td>
                    <td><span class="badge badge-green" x-text="'Lv.' + p.level"></span></td>
                    <td x-text="(p.money||0).toLocaleString() + 'G'"></td>
                    <td class="text-gray-500" x-text="fmtDate(p.created_at)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div class="card p-4">
            <div class="text-xs text-gray-500 mb-3 font-semibold tracking-wider">ìµœê·¼ ê±°ë˜</div>
            <table>
              <thead><tr><th>í”Œë ˆì´ì–´</th><th>ìƒì¸</th><th>ê¸ˆì•¡</th><th>ì¼ì‹œ</th></tr></thead>
              <tbody>
                <template x-for="t in stats.recentTrades || []" :key="t.id">
                  <tr>
                    <td x-text="t.player_name || 'â€”'"></td>
                    <td x-text="t.merchant_name || 'â€”'"></td>
                    <td x-text="(t.total_price||0).toLocaleString() + 'G'"></td>
                    <td class="text-gray-500" x-text="fmtDate(t.created_at)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â”€â”€â”€ í”Œë ˆì´ì–´ â”€â”€â”€ -->
      <div x-show="!loading && page === 'players'">
        <div class="flex gap-3 mb-4">
          <input x-model="playerSearch" @input.debounce.400ms="loadPlayers()" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰..." class="max-w-xs">
          <button @click="loadPlayers()" class="btn-ghost">ê²€ìƒ‰</button>
        </div>
        <div class="card overflow-hidden mb-4">
          <table>
            <thead><tr><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ë ˆë²¨</th><th>ê³¨ë“œ</th><th>ë¼ì´ì„¼ìŠ¤</th><th>ìƒíƒœ</th><th>ê°€ì…ì¼</th><th></th></tr></thead>
            <tbody>
              <template x-for="p in players" :key="p.id">
                <tr>
                  <td class="font-medium" x-text="p.name"></td>
                  <td class="text-gray-400 text-xs" x-text="p.email"></td>
                  <td><span class="badge badge-green" x-text="'Lv.' + p.level"></span></td>
                  <td x-text="(p.money||0).toLocaleString() + 'G'"></td>
                  <td x-text="p.current_license"></td>
                  <td><span :class="p.is_active ? 'badge badge-green' : 'badge badge-red'" x-text="p.is_active ? 'í™œì„±' : 'ì •ì§€'"></span></td>
                  <td class="text-gray-500 text-xs" x-text="fmtDate(p.created_at)"></td>
                  <td class="text-right"><button @click="openPlayer(p)" class="btn-ghost text-xs">ìˆ˜ì •</button></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div class="flex items-center gap-4 text-sm text-gray-400">
          <span>ì´ <strong x-text="playerTotal"></strong>ëª…</span>
          <button @click="playerPage--; loadPlayers()" :disabled="playerPage<=1" class="btn-ghost text-xs disabled:opacity-30">â† ì´ì „</button>
          <span x-text="playerPage + ' / ' + Math.ceil(playerTotal/20)"></span>
          <button @click="playerPage++; loadPlayers()" :disabled="playerPage >= Math.ceil(playerTotal/20)" class="btn-ghost text-xs disabled:opacity-30">ë‹¤ìŒ â†’</button>
        </div>
      </div>

      <!-- â”€â”€â”€ ìƒì¸ â”€â”€â”€ -->
      <div x-show="!loading && page === 'merchants'">
        <div class="grid grid-cols-3 gap-4">
          <template x-for="m in merchants" :key="m.id">
            <div class="card p-4">
              <div class="flex items-start justify-between mb-2">
                <div>
                  <div class="font-bold" x-text="m.name"></div>
                  <div class="text-xs text-gray-500" x-text="m.title"></div>
                </div>
                <span :class="m.is_active ? 'badge badge-green' : 'badge badge-red'" x-text="m.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'"></span>
              </div>
              <div class="text-xs text-gray-500 mb-2" x-text="'êµ¬ì—­: ' + (m.district || m.id)"></div>
              <div class="text-xs text-gray-500 mb-3" x-text="'ì¸ë²¤í† ë¦¬: ' + (m.inventory?.length || 0) + 'ì¢…'"></div>
              <button @click="openMerchant(m)" class="btn-ghost text-xs w-full">ìˆ˜ì •</button>
            </div>
          </template>
        </div>
      </div>

      <!-- â”€â”€â”€ í€˜ìŠ¤íŠ¸ â”€â”€â”€ -->
      <div x-show="!loading && page === 'quests'">
        <div class="card overflow-hidden mb-4">
          <table>
            <thead><tr><th>í”Œë ˆì´ì–´</th><th>í€˜ìŠ¤íŠ¸ ID</th><th>ìƒíƒœ</th><th>ì—…ë°ì´íŠ¸</th></tr></thead>
            <tbody>
              <template x-for="q in quests" :key="q.id">
                <tr>
                  <td class="font-medium" x-text="q.player_name || 'â€”'"></td>
                  <td class="text-xs text-gray-400" x-text="q.quest_id"></td>
                  <td><span :class="q.status === 'completed' ? 'badge badge-green' : q.status === 'active' ? 'badge badge-gold' : 'badge badge-gray'" x-text="q.status"></span></td>
                  <td class="text-gray-500 text-xs" x-text="fmtDate(q.updated_at)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div class="flex items-center gap-4 text-sm text-gray-400">
          <span>ì´ <strong x-text="questTotal"></strong>ê±´</span>
          <button @click="questPage--; loadQuests()" :disabled="questPage<=1" class="btn-ghost text-xs disabled:opacity-30">â† ì´ì „</button>
          <span x-text="questPage"></span>
          <button @click="questPage++; loadQuests()" :disabled="quests.length < 30" class="btn-ghost text-xs disabled:opacity-30">ë‹¤ìŒ â†’</button>
        </div>
      </div>

      <!-- â”€â”€â”€ ê±°ë˜ ë‚´ì—­ â”€â”€â”€ -->
      <div x-show="!loading && page === 'trades'">
        <div class="card overflow-hidden mb-4">
          <table>
            <thead><tr><th>í”Œë ˆì´ì–´</th><th>ìƒì¸</th><th>íƒ€ì…</th><th>ì•„ì´í…œ</th><th>ìˆ˜ëŸ‰</th><th>ê¸ˆì•¡</th><th>ì¼ì‹œ</th></tr></thead>
            <tbody>
              <template x-for="t in trades" :key="t.id">
                <tr>
                  <td class="font-medium" x-text="t.player_name || 'â€”'"></td>
                  <td x-text="t.merchant_name || 'â€”'"></td>
                  <td><span :class="t.trade_type==='buy' ? 'badge badge-green' : 'badge badge-red'" x-text="t.trade_type==='buy' ? 'êµ¬ë§¤' : 'íŒë§¤'"></span></td>
                  <td class="text-gray-400 text-xs" x-text="t.item_id || 'â€”'"></td>
                  <td x-text="t.quantity || 1"></td>
                  <td class="font-medium" style="color:var(--gold)" x-text="(t.total_price||0).toLocaleString() + 'G'"></td>
                  <td class="text-gray-500 text-xs" x-text="fmtDate(t.created_at)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div class="flex items-center gap-4 text-sm text-gray-400">
          <span>ì´ <strong x-text="tradeTotal"></strong>ê±´</span>
          <button @click="tradePage--; loadTrades()" :disabled="tradePage<=1" class="btn-ghost text-xs disabled:opacity-30">â† ì´ì „</button>
          <span x-text="tradePage"></span>
          <button @click="tradePage++; loadTrades()" :disabled="trades.length < 30" class="btn-ghost text-xs disabled:opacity-30">ë‹¤ìŒ â†’</button>
        </div>
      </div>

      <!-- â”€â”€â”€ ë¡œê·¸ â”€â”€â”€ -->
      <div x-show="!loading && page === 'logs'">
        <div class="card p-4 mb-4">
          <template x-for="l in logs" :key="l.id">
            <div class="log-entry">
              <span class="text-gray-600" x-text="fmtDate(l.created_at) + ' '"></span>
              <span class="neon" x-text="'[' + (l.action || l.activity_type || 'event') + '] '"></span>
              <span class="text-gray-300" x-text="l.player_name ? '[' + l.player_name + '] ' : ''"></span>
              <span class="text-gray-400" x-text="l.details || l.description || ''"></span>
            </div>
          </template>
          <div x-show="!logs.length" class="text-gray-500 text-sm py-4 text-center">ë¡œê·¸ ì—†ìŒ</div>
        </div>
        <div class="flex items-center gap-4 text-sm text-gray-400">
          <span>ì´ <strong x-text="logTotal"></strong>ê±´</span>
          <button @click="logPage--; loadLogs()" :disabled="logPage<=1" class="btn-ghost text-xs disabled:opacity-30">â† ì´ì „</button>
          <span x-text="logPage"></span>
          <button @click="logPage++; loadLogs()" :disabled="logs.length < 50" class="btn-ghost text-xs disabled:opacity-30">ë‹¤ìŒ â†’</button>
        </div>
      </div>

      <!-- â”€â”€â”€ ì„œë²„ ìƒíƒœ â”€â”€â”€ -->
      <div x-show="!loading && page === 'server'">
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="stat-card">
            <div class="text-xs text-gray-500 mb-3 tracking-wider font-semibold">ì„œë²„ ìƒíƒœ</div>
            <div class="space-y-3 text-sm">
              <div class="flex justify-between"><span class="text-gray-500">ìƒíƒœ</span><span class="badge badge-green" x-text="health.status || 'â€”'"></span></div>
              <div class="flex justify-between"><span class="text-gray-500">ì—…íƒ€ì„</span><span class="neon" x-text="uptimeStr"></span></div>
              <div class="flex justify-between"><span class="text-gray-500">Node.js</span><span x-text="health.nodeVersion || 'â€”'"></span></div>
              <div class="flex justify-between"><span class="text-gray-500">í™•ì¸ ì‹œê°</span><span class="text-gray-400" x-text="fmtDate(health.timestamp)"></span></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="text-xs text-gray-500 mb-3 tracking-wider font-semibold">ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</div>
            <div class="space-y-3 text-sm" x-show="health.memory">
              <div class="flex justify-between"><span class="text-gray-500">RSS</span><span x-text="fmtMem(health.memory?.rss)"></span></div>
              <div class="flex justify-between"><span class="text-gray-500">Heap ì‚¬ìš©</span><span class="neon" x-text="fmtMem(health.memory?.heapUsed)"></span></div>
              <div class="flex justify-between"><span class="text-gray-500">Heap ì „ì²´</span><span x-text="fmtMem(health.memory?.heapTotal)"></span></div>
              <div class="flex justify-between"><span class="text-gray-500">External</span><span x-text="fmtMem(health.memory?.external)"></span></div>
            </div>
          </div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-gray-500 mb-3 tracking-wider font-semibold">API ì—”ë“œí¬ì¸íŠ¸</div>
          <div class="grid grid-cols-3 gap-2 text-xs">
            <template x-for="ep in endpoints" :key="ep">
              <div class="bg-gray-900 rounded px-3 py-2 font-mono text-gray-400" x-text="ep"></div>
            </template>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- â”€â”€â”€ í”Œë ˆì´ì–´ ìˆ˜ì • ëª¨ë‹¬ â”€â”€â”€ -->
<div x-show="playerModal" class="modal-overlay" @click.self="playerModal = false">
  <div class="modal" @click.stop>
    <div class="font-bold text-lg mb-4" x-text="'í”Œë ˆì´ì–´ ìˆ˜ì •: ' + (editPlayer.name || '')"></div>
    <div class="space-y-3 mb-5">
      <div><label class="text-xs text-gray-500 mb-1 block">ë ˆë²¨</label><input type="number" x-model.number="editPlayer.level"></div>
      <div><label class="text-xs text-gray-500 mb-1 block">ê³¨ë“œ</label><input type="number" x-model.number="editPlayer.money"></div>
      <div><label class="text-xs text-gray-500 mb-1 block">ë¼ì´ì„¼ìŠ¤</label><input type="number" x-model.number="editPlayer.current_license"></div>
      <div class="flex items-center gap-3">
        <input type="checkbox" x-model="editPlayer.is_active" class="w-4 h-4">
        <label class="text-sm">ê³„ì • í™œì„±í™”</label>
      </div>
    </div>
    <div class="flex justify-between">
      <button @click="deletePlayer()" class="btn-danger text-sm">ì‚­ì œ</button>
      <div class="flex gap-2">
        <button @click="playerModal = false" class="btn-ghost text-sm">ì·¨ì†Œ</button>
        <button @click="savePlayer()" class="btn-neon text-sm">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ ìƒì¸ ìˆ˜ì • ëª¨ë‹¬ â”€â”€â”€ -->
<div x-show="merchantModal" class="modal-overlay" @click.self="merchantModal = false">
  <div class="modal" @click.stop>
    <div class="font-bold text-lg mb-4" x-text="'ìƒì¸ ìˆ˜ì •: ' + (editMerchant.name || '')"></div>
    <div class="space-y-3 mb-5">
      <div><label class="text-xs text-gray-500 mb-1 block">ì´ë¦„</label><input type="text" x-model="editMerchant.name"></div>
      <div><label class="text-xs text-gray-500 mb-1 block">ì§í•¨</label><input type="text" x-model="editMerchant.title"></div>
      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-xs text-gray-500 mb-1 block">ìœ„ë„</label><input type="number" step="0.0001" x-model.number="editMerchant.latitude"></div>
        <div><label class="text-xs text-gray-500 mb-1 block">ê²½ë„</label><input type="number" step="0.0001" x-model.number="editMerchant.longitude"></div>
      </div>
      <div class="flex items-center gap-3">
        <input type="checkbox" x-model="editMerchant.is_active" class="w-4 h-4">
        <label class="text-sm">ìƒì¸ í™œì„±í™”</label>
      </div>
    </div>
    <div class="text-xs text-gray-500 mb-3" x-show="editMerchant.inventory?.length">
      ì¸ë²¤í† ë¦¬: <span x-text="editMerchant.inventory?.length"></span>ê°œ ì•„ì´í…œ
    </div>
    <div class="flex justify-end gap-2">
      <button @click="merchantModal = false" class="btn-ghost text-sm">ì·¨ì†Œ</button>
      <button @click="saveMerchant()" class="btn-neon text-sm">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ ì•Œë¦¼ í† ìŠ¤íŠ¸ â”€â”€â”€ -->
<div x-show="toast.show" x-transition class="fixed bottom-6 right-6 px-4 py-3 rounded shadow-xl text-sm font-medium z-50"
  :class="toast.ok ? 'bg-emerald-900 border border-emerald-500 text-emerald-200' : 'bg-red-900 border border-red-500 text-red-200'"
  x-text="toast.msg"></div>

<script>
function app() {
  return {
    token: localStorage.getItem('admin_token') || '',
    loginPw: '', loginError: '',
    page: 'dashboard', loading: false,

    navItems: [
      { id: 'dashboard', label: 'ëŒ€ì‹œë³´ë“œ', icon: 'âŠ' },
      { id: 'players',   label: 'í”Œë ˆì´ì–´ ê´€ë¦¬', icon: 'ğŸ‘¤' },
      { id: 'merchants', label: 'ìƒì¸ ê´€ë¦¬', icon: 'ğŸ®' },
      { id: 'quests',    label: 'í€˜ìŠ¤íŠ¸', icon: 'ğŸ“œ' },
      { id: 'trades',    label: 'ê±°ë˜ ë‚´ì—­', icon: 'ğŸ’±' },
      { id: 'logs',      label: 'í™œë™ ë¡œê·¸', icon: 'ğŸ“‹' },
      { id: 'server',    label: 'ì„œë²„ ìƒíƒœ', icon: 'ğŸ–¥' },
    ],

    endpoints: [
      'GET /api/auth', 'POST /api/auth/login', 'GET /api/player/profile',
      'PUT /api/player/location', 'GET /api/merchants', 'POST /api/trade/buy',
      'POST /api/trade/sell', 'GET /api/quests', 'POST /api/merchant-chat',
      'POST /api/story/chapter/reward',
    ],

    stats: {}, health: {}, players: [], playerTotal: 0, playerPage: 1, playerSearch: '',
    merchants: [], quests: [], questTotal: 0, questPage: 1,
    trades: [], tradeTotal: 0, tradePage: 1, logs: [], logTotal: 0, logPage: 1,
    playerModal: false, editPlayer: {}, merchantModal: false, editMerchant: {},
    toast: { show: false, msg: '', ok: true },

    get uptimeStr() {
      const s = Math.floor(this.health.uptime || 0);
      const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
      return `${h}h ${m}m ${sec}s`;
    },

    async init() {
      if (this.token) { await this.loadPage(); await this.loadHealth(); }
      setInterval(() => this.loadHealth(), 30000);
    },

    async login() {
      this.loginError = '';
      const r = await fetch('/admin/api/auth', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: this.loginPw }) });
      if (r.ok) {
        const d = await r.json();
        this.token = d.token;
        localStorage.setItem('admin_token', this.token);
        await this.loadPage(); await this.loadHealth();
      } else {
        this.loginError = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤';
      }
    },

    logout() { this.token = ''; localStorage.removeItem('admin_token'); },

    headers() { return { Authorization: `Bearer ${this.token}` }; },

    async api(url) {
      const r = await fetch(url, { headers: this.headers() });
      if (r.status === 401) { this.logout(); return null; }
      return r.json();
    },

    async apiFetch(url, method, body) {
      const r = await fetch(url, { method, headers: { ...this.headers(), 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      return r.json();
    },

    async loadPage() {
      this.loading = true;
      try {
        if (this.page === 'dashboard') await this.loadStats();
        else if (this.page === 'players') await this.loadPlayers();
        else if (this.page === 'merchants') await this.loadMerchants();
        else if (this.page === 'quests') await this.loadQuests();
        else if (this.page === 'trades') await this.loadTrades();
        else if (this.page === 'logs') await this.loadLogs();
        else if (this.page === 'server') await this.loadHealth();
      } finally { this.loading = false; }
    },

    async loadStats() { const d = await this.api('/admin/api/stats'); if (d) this.stats = d; },
    async loadHealth() { const d = await this.api('/admin/api/health'); if (d) this.health = d; },
    async loadPlayers() {
      const d = await this.api(`/admin/api/players?search=${encodeURIComponent(this.playerSearch)}&page=${this.playerPage}`);
      if (d) { this.players = d.players; this.playerTotal = d.total; }
    },
    async loadMerchants() { const d = await this.api('/admin/api/merchants'); if (d) this.merchants = d.merchants; },
    async loadQuests() { const d = await this.api(`/admin/api/quests?page=${this.questPage}`); if (d) { this.quests = d.quests; this.questTotal = d.total; } },
    async loadTrades() { const d = await this.api(`/admin/api/trades?page=${this.tradePage}`); if (d) { this.trades = d.trades; this.tradeTotal = d.total; } },
    async loadLogs() { const d = await this.api(`/admin/api/logs?page=${this.logPage}`); if (d) { this.logs = d.logs; this.logTotal = d.total; } },

    openPlayer(p) { this.editPlayer = { ...p }; this.playerModal = true; },
    async savePlayer() {
      const r = await this.apiFetch(`/admin/api/players/${this.editPlayer.id}`, 'PUT', this.editPlayer);
      if (r.ok) { this.showToast('ì €ì¥ ì™„ë£Œ', true); this.playerModal = false; await this.loadPlayers(); }
      else this.showToast(r.error || 'ì €ì¥ ì‹¤íŒ¨', false);
    },
    async deletePlayer() {
      if (!confirm(`"${this.editPlayer.name}" í”Œë ˆì´ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      const r = await this.apiFetch(`/admin/api/players/${this.editPlayer.id}`, 'DELETE');
      if (r.ok) { this.showToast('ì‚­ì œ ì™„ë£Œ', true); this.playerModal = false; await this.loadPlayers(); }
      else this.showToast(r.error || 'ì‚­ì œ ì‹¤íŒ¨', false);
    },

    openMerchant(m) { this.editMerchant = { ...m }; this.merchantModal = true; },
    async saveMerchant() {
      const r = await this.apiFetch(`/admin/api/merchants/${this.editMerchant.id}`, 'PUT', this.editMerchant);
      if (r.ok) { this.showToast('ì €ì¥ ì™„ë£Œ', true); this.merchantModal = false; await this.loadMerchants(); }
      else this.showToast(r.error || 'ì €ì¥ ì‹¤íŒ¨', false);
    },

    showToast(msg, ok) {
      this.toast = { show: true, msg, ok };
      setTimeout(() => this.toast.show = false, 3000);
    },

    fmtDate(dt) {
      if (!dt) return 'â€”';
      const d = new Date(dt);
      return d.toLocaleDateString('ko-KR') + ' ' + d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    },
    fmtMem(b) { if (!b) return 'â€”'; return (b / 1024 / 1024).toFixed(1) + ' MB'; },
  };
}
</script>
</body>
</html>
